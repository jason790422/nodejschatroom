<!doctype html>
<html>
<head>
	<title>Yo Yo Yo</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<link rel="stylesheet" type="text/css" href="semantic/out/semantic.min.css">
	<script src="semantic/out/semantic.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script>
		var socket = io();
		$(document).ready(function() {
			var name = "";
			$('.ui.basic.modal').modal({
				closable: false,
				blurring: true,
				onDeny  : function() {
					name = "";
					console.log(name);
					if ( name == "" || name == null || name == "guest" ) {
						name = "guest" + Math.floor((Math.random() * 1000) + 1);
					}
					socket.emit("add user", name);
				},
    			onApprove : function() {
    				name = $("#user_name").val();
    				console.log(name);
    				socket.emit("add user", name);
    			}	
			}).modal('show');
			// var name = prompt("請輸入暱稱","guest");
			
			//tell server
			// socket.emit("add user",name);
			//監聽新訊息事件
			socket.on('chat message', function(data) {
				appendMessage(data.username, data.msg);
			});
			socket.on('add user', function(data) {
				addUsers(data.username + "已加入");
				// appendUsers(data.pic, data.username);
			});

			socket.on('all users', function(data) {
				var sb = '';
				console.log("len:"+data.namedata.length);
				for(var d = 0; d < data.namedata.length; d++ ) {
					console.log("name:"+data.namedata[d]);
					// console.log("pic:"+data[d].picdata);
					// appendUsers(data[d].pic, data[d].username);
					sb += '<a class="ui label" id="'+data.namedata[d]+'"><img class="ui right spaced avatar image" src="'+data.picdata[d]+'">'+data.namedata[d]+'</a>';
					// sb += '<a class="ui label" id="'+data.namedata[d]+'">'+data.namedata[d]+'</a>';
					// sb += data[d] + "&lt;br />";
				}
				// $('div#users').html(sb);
				$("#message_use .label").remove();
				$("#message_use").append(sb);
			});

			socket.on('user left', function(data) {
				leftUsers(data.username + "已離開");
				deleteUsers(data.username);
			});
			$('#send').click(function() {
				var text = $('#m').val();
				if ( text != "" ) {
					socket.emit('chat message', text);
					$('#m').val('');
					return false;
				}
			});
			$("#m").keydown(function(event) {
				if ( event.which == 13 ) {
					$('#send').click();
				}
			});
			function addUsers(msg) {
				$('#messages').append('<div class="ui green icon message"><i class="user icon"></i><div class="content"><p>'+msg+'</p></div></div>');
			}
			function leftUsers(msg) {
				$('#messages').append('<div class="ui pink icon message"><i class="user icon"></i><div class="content"><p>'+msg+'</p></div></div>');
			}
			function appendMessage(name, msg) {
				// $('#messages').append($('<li>').text(msg));
				$('#messages').append('<div class="ui icon message"><i class="comment outline icon"></i><div class="content"><div class="header">'+name+'</div><p>'+msg+'</p></div></div>');
				document.body.scrollTop = document.body.scrollHeight;	
			}
			function appendUsers(pic, name) {
				$("#message_use").append('<a class="ui label" id="'+name+'"><img class="ui right spaced avatar image" src="'+pic+'">'+name+'</a>');
			}
			// function deleteUsers(name) {
			// 	$("#"+name).remove();
			// }
			$(".message .close").click(function() {
				$(this).closest(".message").transition("fade");
			});
		}); 
	</script>
</head>
<body>
	<div class="ui basic modal">
		<!-- <i class="close icon"></i> -->
		<div class="header">請輸入名稱</div>
		<div class="image content">
			<div class="image">
				<i class="user icon"></i>
			</div>
			<div class="description">
				<div class="ui inverted transparent icon input">
					<input type="text" id="user_name" name="user_name" placeholder="Your Name" maxlength="100">
					<i class="search icon"></i>
				</div>
			</div>
		</div>
		<div class="actions">
			<div class="two fluid ui inverted buttons">
				<div class="ui cancel red basic inverted button">
					<i class="remove icon"></i>No
				</div>
				<div class="ui ok green basic inverted button">
					<i class="checkmark icon"></i>Yes
				</div>
			</div>
		</div>
	</div>
	<div class="ui huge violet message" id="message_use">
		<i class="close icon" id="message_close"></i>
	</div>
	<div class="ui column stackable grid" style="min-height: 500px;" id="message_block">
		<div class="column" id="messages">
		</div>
	</div>
	<div class="ui three column stackable grid">
		<div class="two wide column">
			<div class="ui icon buttons">
				<button class="ui button">
					<i class="smile icon"></i>
				</button>
				<button class="ui button">
					<i class="file outline icon"></i>
				</button>
			</div>
		</div>
		<div class="ten wide column">
			<div class="ui fluid input">
				<input type="text" id="m" placeholder="Something..." autocomplete="off" maxlength="100">
			</div>
		</div>
		<div class="one wide column">
			<button class="ui inverted violet button" id="send">Send</button>
		</div>
	</div>
</body>
</html>